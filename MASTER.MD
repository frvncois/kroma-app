# KROMA ‚Äî Master Specification

> **Codename:** Kroma
> **Purpose:** Centralized order management + logistics hub for a print shop operation with 3 printshop locations.
> **Stack:** Vue 3, Shadcn-vue, Pinia, Supabase (Postgres, Auth, Storage, Realtime), Vercel
> **Context:** Internal tool for ~6-7 concurrent users. Not publicly accessible. No sensitive data.

---

## 1. Business Context

The client operates **3 print shops** (In House, Victor, Studio C ‚Äî more may be added later). Orders come in from multiple channels. Kroma centralizes all orders into one system where employees manage production and drivers handle deliveries.

### Order Sources (Branded Store Names)
- **Impression Qu√©bec** (`impression_quebec`) ‚Äî Shopify store
- **Promo Flash** (`promo_flash`) ‚Äî Shopify store
- **Propaganda** (`propaganda`) ‚Äî Shopify store
- **Sticker Pusher** (`sticker_pusher`) ‚Äî Shopify store
- **Studio C** (`studio_c`) ‚Äî Shopify store
- **Other** (`other`) ‚Äî Custom web forms, manual entry, or other channels

---

## 2. Roles & Permissions

There are 3 roles. Each user has exactly one role.

### 2.1 Manager (General Manager)
- Can also act as a Printshop Manager
- Scoped to all shops (full visibility)
- **Can:** See all orders, create manual orders, assign printshop to items, assign items to driver, manage payment status, see full order lifecycle, cancel items, create/edit customers, create driver tasks, add notes to orders and items
- **Cannot:** Optimize delivery routes

### 2.2 Printshop Manager
- Scoped to one or more specific shops (e.g., Victor only, or In House + Studio C)
- **Can:** See items assigned to their shop(s), change status on items, add notes to orders and items, cancel items, mark items as picked up
- **Cannot:** See all orders, assign printshops, create orders, manage payment, deliver

### 2.3 Driver
- No shop scoping
- **Can:** See orders ready for delivery, change status on items, add notes to items, add photos to items/tasks, create driver tasks, optimize routes via AI, mark items as out_for_delivery/delivered/picked_up
- **Cannot:** See all orders, manage production, manage payment, cancel items, create orders

### 2.4 Permission Matrix

| Action                  | Manager | Printshop Manager | Driver |
|-------------------------|---------|-------------------|--------|
| See all orders          | ‚úÖ      | ‚ùå                | ‚ùå     |
| See their shop's items  | ‚úÖ      | ‚úÖ                | ‚ùå     |
| See ready-for-delivery  | ‚úÖ      | ‚ùå                | ‚úÖ     |
| Assign printshop        | ‚úÖ      | ‚ùå                | ‚ùå     |
| Assign items to driver  | ‚úÖ      | ‚ùå                | ‚ùå     |
| Manage payment status   | ‚úÖ      | ‚ùå                | ‚ùå     |
| Create manual order     | ‚úÖ      | ‚ùå                | ‚ùå     |
| Create/edit customer    | ‚úÖ      | ‚ùå                | ‚ùå     |
| Create driver tasks     | ‚úÖ      | ‚ùå                | ‚úÖ     |
| Add notes to orders     | ‚úÖ      | ‚úÖ                | ‚ùå     |
| Add notes to items      | ‚úÖ      | ‚úÖ                | ‚úÖ     |
| Add photos to items     | ‚úÖ      | ‚ùå                | ‚úÖ     |
| Set `assigned`          | ‚úÖ      | ‚ùå                | ‚ùå     |
| Set `in_production`     | ‚úÖ      | ‚úÖ                | ‚ùå     |
| Set `on_hold`           | ‚úÖ      | ‚úÖ                | ‚ùå     |
| Set `ready`             | ‚úÖ      | ‚úÖ                | ‚ùå     |
| Set `out_for_delivery`  | ‚úÖ      | ‚ùå                | ‚úÖ     |
| Set `delivered`         | ‚úÖ      | ‚ùå                | ‚úÖ     |
| Set `picked_up`         | ‚úÖ      | ‚úÖ                | ‚úÖ     |
| Set `canceled`          | ‚úÖ      | ‚úÖ                | ‚ùå     |
| Route optimization      | ‚ùå      | ‚ùå                | ‚úÖ     |

---

## 3. Item Status Flow

**CRITICAL: Tracking is at the ITEM level, not the order level.** A single order can contain items assigned to different printshops, each with independent statuses. The order-level status is a rollup of its items.

### 3.1 Statuses

| Status              | Description                                      |
|---------------------|--------------------------------------------------|
| `new`               | Just ingested, not yet reviewed                  |
| `assigned`          | Manager assigned a printshop, not yet in production |
| `in_production`     | Printshop is actively working on it              |
| `on_hold`           | Paused ‚Äî needs follow-up or info                 |
| `ready`             | Production complete, waiting for delivery/pickup |
| `out_for_delivery`  | On the truck, driver is delivering               |
| `delivered`         | ‚úÖ Terminal ‚Äî delivered to customer               |
| `picked_up`         | ‚úÖ Terminal ‚Äî customer picked up at shop          |
| `canceled`          | ‚úÖ Terminal ‚Äî item was canceled                   |

### 3.2 Status Flow Diagram

```
new ‚Üí assigned ‚Üí in_production ‚Üí ready ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚Üí out_for_delivery ‚Üí delivered
                      ‚Üï             ‚îÇ    ‚îÇ          ‚Üï
                    on_hold         ‚îÇ    ‚îÇ        on_hold
                      ‚Üì             ‚îÇ    ‚îÇ          ‚Üì
                   canceled         ‚îÇ    ‚îÇ       canceled
                                    ‚îÇ    ‚îÇ
                                    ‚îÇ    ‚îî‚îÄ‚îÄ‚Üí picked_up
                                    ‚îÇ
                                    ‚îî‚îÄ‚îÄ‚Üí [billing webhook fires]
```

### 3.3 Terminal States
Every item ends in one of: **`delivered`**, **`picked_up`**, or **`canceled`**.

### 3.4 Auto-Set Dates on Status Change
- When status ‚Üí `in_production`: auto-set `production_start_date` to now
- When status ‚Üí `ready`: auto-set `production_ready_date` to now
- When status ‚Üí `delivered`: auto-set `delivery_date` to now (on the item)
- When status ‚Üí `picked_up`: auto-set `delivery_date` to now (on the item)

### 3.5 Billing Webhook
- Fires **per item** when status changes to `ready`
- Sends order + item + customer data to an external billing app (TBD)
- Payload must include payment status so billing app knows if already paid

---

## 4. Payment Tracking

**Payment is a Manager-only concern.** Printshop Managers and Drivers never see payment information.

### 4.1 Payment Fields on Order

| Field              | Type     | Description                                      |
|--------------------|----------|--------------------------------------------------|
| `payment_status`   | enum     | `paid`, `unpaid`, `partial`                      |
| `payment_method`   | enum     | `shopify`, `cash`, `cheque`, `etransfer`, `invoice`, `other` |
| `amount_total`     | decimal  | Total order amount                               |
| `amount_paid`      | decimal  | Amount collected so far                          |

### 4.2 Payment Rules
- **Shopify orders** ‚Üí arrive as `paid` (Shopify collected payment)
- **Manual / web form orders** ‚Üí arrive as `unpaid` by default
- Manager can update payment status at any time
- Payment does NOT block production or delivery ‚Äî unpaid orders flow through the full pipeline
- Driver does not collect payment and does not see payment info

---

## 5. Delivery Method

**Delivery method is per-item, not per-order.** This allows split fulfillment ‚Äî some items in an order delivered, others picked up by the customer.

| Method              | Flow                                         |
|---------------------|----------------------------------------------|
| `delivery`          | `ready` ‚Üí `out_for_delivery` ‚Üí `delivered`   |
| `customer_pickup`   | `ready` ‚Üí `picked_up`                        |

- Items with `delivery_method = 'delivery'` appear in the Driver's queue when status is `ready`
- Items with `delivery_method = 'customer_pickup'` never appear in the Driver's queue
- Any role (Manager, Printshop Manager, Driver) can mark `picked_up`
- Order-level delivery display is a computed rollup: if all items are `delivery` ‚Üí show delivery. All `customer_pickup` ‚Üí show pickup. Mixed ‚Üí show both.

---

## 6. Order Ingestion

### 6.1 Shopify Webhooks
- Multiple Shopify stores, each with its own webhook configuration
- Shopify fires `orders/create` and `orders/updated` webhooks ‚Üí Kroma Vercel API endpoint
- Each store has its own webhook secret for verification
- Kroma normalizes the Shopify payload into internal schema
- Files attached to Shopify orders are downloaded and stored in Supabase Storage
- Orders arrive with `source` set to the branded store name (e.g., `impression_quebec`, `promo_flash`)
- Orders arrive with `payment_status: paid`

### 6.2 Custom Web Forms
- External websites POST to `/api/ingest/webform`
- Kroma normalizes into internal schema
- Orders arrive with `source: other`
- Orders arrive with `payment_status: unpaid` (default)

### 6.3 Manual Entry
- Manager fills out order form in Kroma UI
- Full control over all fields
- Manager sets source, payment status, and delivery method per item manually

### 6.4 Customer Matching
- On ingestion, match customer by email
- If no match, create a new customer record
- Managers can merge duplicate customers later

---

## 7. Data Model

### 7.1 Tables

#### `customers`
| Column      | Type        | Notes                              |
|-------------|-------------|------------------------------------|
| id          | uuid        | PK                                 |
| name        | text        | Full name                          |
| email       | text        | Unique, used for matching          |
| phone       | text        |                                    |
| company     | text        | Nullable                           |
| address     | text        | Delivery address                   |
| lat         | decimal     | For route optimization             |
| lng         | decimal     | For route optimization             |
| notes       | text        | Static customer notes              |
| created_at  | timestamptz |                                    |
| updated_at  | timestamptz |                                    |

#### `orders`
| Column            | Type        | Notes                                          |
|-------------------|-------------|-------------------------------------------------|
| id                | uuid        | PK                                              |
| customer_id       | uuid        | FK ‚Üí customers                                  |
| source            | enum        | `impression_quebec`, `promo_flash`, `propaganda`, `sticker_pusher`, `studio_c`, `other` |
| external_id       | text        | Shopify order ID or external ref. Nullable       |
| payment_status    | enum        | `paid`, `unpaid`, `partial`                      |
| payment_method    | enum        | `shopify`, `cash`, `cheque`, `etransfer`, `invoice`, `other` |
| amount_total      | decimal     |                                                  |
| amount_paid       | decimal     |                                                  |
| internal_notes    | text        | Static manager notes (e.g., "COD - collect on delivery"). Not part of collaborative notes system. |
| created_at        | timestamptz |                                                  |
| updated_at        | timestamptz |                                                  |

**Computed fields (not stored on orders):**
- `files_count` ‚Äî computed from `order_files` where `entity_type = 'order_item'` and `file_type` in (artwork, proof, reference) across all items in the order
- `notes_count` ‚Äî computed from `notes` table where `entity_type` in (order, order_item) related to this order
- `statusRollup` ‚Äî derived from item statuses (see Section 14)
- `deliveryMethodRollup` ‚Äî derived from item delivery methods

#### `order_items`
| Column              | Type        | Notes                                          |
|---------------------|-------------|-------------------------------------------------|
| id                  | uuid        | PK                                              |
| order_id            | uuid        | FK ‚Üí orders                                     |
| product_name        | text        |                                                  |
| description         | text        | Specs, size, material, etc.                      |
| quantity            | integer     |                                                  |
| specs               | jsonb       | Flexible field for print specs                   |
| assigned_printshop  | uuid        | FK ‚Üí printshops. Nullable until assigned         |
| status              | enum        | See Section 3.1                                  |
| delivery_method     | enum        | `delivery`, `customer_pickup`. Default: `delivery` |
| notes               | text        | Legacy field ‚Äî collaborative notes go through `notes` table |
| due_date            | date        | Nullable. Set at order creation, editable by Manager |
| production_start_date | timestamptz | Nullable. Auto-set when status ‚Üí `in_production` |
| production_ready_date | timestamptz | Nullable. Auto-set when status ‚Üí `ready`       |
| delivery_date       | timestamptz | Nullable. Auto-set when driver marks `delivered` or `picked_up` |
| created_at          | timestamptz |                                                 |
| updated_at          | timestamptz |                                                 |

**Key clarifications:**
- `due_date` = internal production deadline, set when order is created, editable
- `delivery_date` = actual timestamp when the driver marked this item as `delivered` or `picked_up`. Lives on the item (not the order) because items in the same order can be delivered at different times.
- `delivery_method` = per-item, enabling split fulfillment within a single order

#### `order_files` (extended ‚Äî also covers driver photos)
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| entity_type    | enum        | `order_item`, `driver_task`                      |
| entity_id      | uuid        | Polymorphic FK to the parent entity              |
| file_url       | text        | Supabase Storage path                            |
| file_name      | text        | Original filename                                |
| file_type      | enum        | `artwork`, `proof`, `reference`, `delivery_photo`, `issue_photo`, `other` |
| uploaded_by    | uuid        | FK ‚Üí users. Required.                            |
| created_at     | timestamptz |                                                  |

**File type semantics:**
- `artwork`, `proof`, `reference` = production files (uploaded by manager or ingested from Shopify)
- `delivery_photo`, `issue_photo` = captured by driver at delivery stops
- Production file count in the orders table = only artwork/proof/reference (not delivery photos)

#### `notes` (polymorphic ‚Äî orders, items, driver tasks)
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| entity_type    | enum        | `order`, `order_item`, `driver_task`             |
| entity_id      | uuid        | Polymorphic FK to the parent entity              |
| content        | text        | Note content (supports @mentions and /mentions)  |
| departments    | enum[]      | `printshop`, `delivery`, `billing`, `everyone`. Default: `{everyone}` |
| created_by     | uuid        | FK ‚Üí users. Required.                            |
| created_at     | timestamptz |                                                  |
| updated_at     | timestamptz |                                                  |

**Notes design:**
- If a note is about a specific item ‚Üí `entity_type = 'order_item'`, `entity_id` = item ID
- If a note is about the whole order ‚Üí `entity_type = 'order'`, `entity_id` = order ID
- If a note is on a driver task ‚Üí `entity_type = 'driver_task'`, `entity_id` = task ID
- No `item_reference` field ‚Äî target entities directly via `entity_type/entity_id`
- Departments control visibility filtering (e.g., printshop managers see notes tagged `printshop` or `everyone`)

#### `activities` (write-once event log)
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| type           | enum        | `status_change`, `note_added`, `delivery`, `pickup`, `assignment`, `order_created`, `alert`, `task_created` |
| user_id        | uuid        | FK ‚Üí users. Who performed the action.            |
| entity_type    | enum        | `order`, `order_item`, `driver_task`             |
| entity_id      | uuid        | What entity was affected                         |
| order_id       | uuid        | FK ‚Üí orders. Nullable. For quick order-level filtering. |
| printshop_id   | uuid        | FK ‚Üí printshops. Nullable. For quick shop-level filtering. |
| details        | jsonb       | Flexible payload: message, from, to, note, alert info, etc. |
| created_at     | timestamptz |                                                  |

**Activity design:**
- Every mutation that matters writes an activity row (write-once, never updated)
- Single Supabase Realtime subscription for the feed
- `seen` and `important` are NOT stored on activities ‚Äî these are per-user client-side state (localStorage)
- Role scoping is computed at read time in the frontend (same logic as `getActivitiesForRole()`)

#### `status_history`
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| order_item_id  | uuid        | FK ‚Üí order_items                                 |
| from_status    | enum        | Previous status. Nullable for first entry        |
| to_status      | enum        | New status                                       |
| changed_by     | uuid        | FK ‚Üí users                                       |
| note           | text        | Optional reason                                  |
| created_at     | timestamptz |                                                  |

**Loading strategy:** Lazy-loaded on demand. Items load WITHOUT history by default. When a user opens the detail sheet, a separate query fetches `status_history` for that item. This keeps list queries fast and realtime payloads small.

**Phase 1 note:** Status history is embedded as an array on `order_items` in mock data. In Phase 2 (Supabase), it becomes this separate table.

#### `driver_tasks`
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| created_by     | uuid        | FK ‚Üí users. Required.                            |
| assigned_to    | uuid        | FK ‚Üí users. Required (always assigned to a specific driver). |
| title          | text        |                                                  |
| type           | enum        | `pickup`, `dropoff`, `errand`, `other`           |
| priority       | enum        | `low`, `medium`, `high`, `urgent`                |
| details        | text        |                                                  |
| address        | text        | Required.                                        |
| lat            | decimal     | For route optimization                           |
| lng            | decimal     | For route optimization                           |
| complete_by    | timestamptz | Deadline                                         |
| status         | enum        | `pending`, `in_progress`, `completed`, `canceled` |
| completed_at   | timestamptz | Nullable. Set when status ‚Üí completed.           |
| created_at     | timestamptz |                                                  |
| updated_at     | timestamptz |                                                  |

**Driver task design:**
- Both Manager and Driver can create tasks, but `assigned_to` is always required
- Tasks appear as route stops (`type: 'task'`) in the driver route system
- Notes on tasks go through the polymorphic `notes` table (`entity_type: 'driver_task'`)
- Photos on tasks go through `order_files` (`entity_type: 'driver_task'`)

#### `printshops`
| Column      | Type        | Notes                              |
|-------------|-------------|------------------------------------|
| id          | uuid        | PK                                 |
| name        | text        | e.g., "In House", "Victor", "Studio C" |
| address     | text        |                                    |
| lat         | decimal     | For route optimization             |
| lng         | decimal     | For route optimization             |

Current printshops: **In House**, **Victor**, **Studio C**. More may be added later.

#### `users`
| Column            | Type        | Notes                                          |
|-------------------|-------------|-------------------------------------------------|
| id                | uuid        | PK, matches Supabase Auth user ID               |
| name              | text        |                                                  |
| email             | text        | Unique                                           |
| role              | enum        | `manager`, `printshop_manager`, `driver`         |
| assigned_shops    | uuid[]      | Array of printshop IDs. Empty for manager/driver |
| created_at        | timestamptz |                                                  |
| updated_at        | timestamptz |                                                  |

**Phase 1 mock users:**

| Email              | Name           | Role              | Assigned Shops | Password |
|--------------------|----------------|-------------------|----------------|----------|
| manager@example.com| Manager        | manager             | [] (all access)| 1234     |
| victor@example.com | Victor         | printshop_manager   | ['victor']     | 1234     |
| driver@example.com | Drivery         | driver             | []             | 1234     |

#### `deliveries` (Phase 4)
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| driver_id      | uuid        | FK ‚Üí users                                       |
| date           | date        |                                                  |
| status         | enum        | `planned`, `in_progress`, `completed`            |
| optimized_route| jsonb       | Google Maps response data                        |
| created_at     | timestamptz |                                                  |
| updated_at     | timestamptz |                                                  |

#### `delivery_stops` (Phase 4)
| Column         | Type        | Notes                                          |
|----------------|-------------|-------------------------------------------------|
| id             | uuid        | PK                                              |
| delivery_id    | uuid        | FK ‚Üí deliveries                                  |
| order_id       | uuid        | FK ‚Üí orders                                      |
| type           | enum        | `pickup`, `dropoff`                              |
| printshop_id   | uuid        | FK ‚Üí printshops. For pickup stops only           |
| address        | text        |                                                  |
| lat            | decimal     |                                                  |
| lng            | decimal     |                                                  |
| sequence_order | integer     | Position in optimized route                      |
| status         | enum        | `pending`, `completed`                           |
| created_at     | timestamptz |                                                  |
| updated_at     | timestamptz |                                                  |

### 7.2 Relationship Map

```
customers (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (N) orders
                           ‚îÇ
                           ‚îú‚îÄ‚îÄ customer_id ‚Üí customers.id
                           ‚îÇ
orders (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (N) order_items
                           ‚îÇ
                           ‚îú‚îÄ‚îÄ order_id ‚Üí orders.id
                           ‚îú‚îÄ‚îÄ assigned_printshop ‚Üí printshops.id (nullable)
                           ‚îú‚îÄ‚îÄ delivery_method (per item)
                           ‚îÇ
order_items (1) ‚îÄ‚îÄ‚îÄ< (N) order_files     (via entity_type='order_item', entity_id)
order_items (1) ‚îÄ‚îÄ‚îÄ< (N) notes           (via entity_type='order_item', entity_id)
order_items (1) ‚îÄ‚îÄ‚îÄ< (N) status_history  (via order_item_id)
                           ‚îÇ
orders (1) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ< (N) notes           (via entity_type='order', entity_id)
                           ‚îÇ
printshops (1) ‚îÄ‚îÄ‚îÄ‚îÄ< (N) order_items     (via assigned_printshop)
                           ‚îÇ
users ‚îÄ‚îÄ‚îÄ‚îÄ role + assigned_shops[]
  ‚îÇ
  ‚îú‚îÄ‚îÄ< driver_tasks          (via assigned_to / created_by)
  ‚îÇ       ‚îÇ
  ‚îÇ       ‚îú‚îÄ‚îÄ< order_files   (via entity_type='driver_task', entity_id)
  ‚îÇ       ‚îî‚îÄ‚îÄ< notes         (via entity_type='driver_task', entity_id)
  ‚îÇ
  ‚îî‚îÄ‚îÄ< activities             (via user_id)
  ‚îÇ
  ‚îî‚îÄ‚îÄ< deliveries ‚îÄ‚îÄ< delivery_stops   (Phase 4)
```

### 7.3 Activity Feed

The activity feed is a **write-once event log** stored in the `activities` table. Every significant mutation writes an activity row.

**Activity types:**
- `status_change` ‚Äî Item status changed
- `note_added` ‚Äî Note added to order/item/task
- `delivery` ‚Äî Item out for delivery or delivered
- `pickup` ‚Äî Item picked up
- `assignment` ‚Äî Item assigned to printshop
- `order_created` ‚Äî New order created
- `alert` ‚Äî System alert (overdue, stuck, etc.)
- `task_created` ‚Äî Driver task created

**Realtime:** Single Supabase Realtime subscription on the `activities` table. All clients receive all inserts and filter by role in the frontend.

**Per-user state:** `seen` and `important` flags are stored client-side (localStorage), not on the activity row. This avoids per-user state in a shared table.

#### Activity Scoping by Role

The activity feed is filtered based on the current user's role:
- **Manager:** Sees all activities across the system
- **Printshop Manager:** Sees activities for items assigned to their shop(s), plus new order notifications
- **Driver:** Sees delivery/pickup activities, status changes to/from delivery-related statuses (ready, out_for_delivery, delivered, picked_up), assignment notifications, and new order notifications

Scoping is computed at read time in the frontend based on the activity's metadata (order_id, printshop_id, entity assignment, activity type). No separate scope field is stored ‚Äî this keeps the data model clean and allows dynamic recomputation when items are reassigned.

---

## 8. Views Per Role

### 8.1 Manager Dashboard
- **Order Queue** ‚Äî All orders, filterable by status, source, printshop, date, payment status
- **Order Detail** ‚Äî Full view: customer, items, files, payment, status history
- **Order Review** ‚Äî Assign items to printshops, update payment, change statuses
- **Manual Order Entry** ‚Äî Full form to create orders (search/create customer, add items with per-item delivery method, upload files)
- **Customer Management** ‚Äî Customer table with search, inline stats (total, active, new this month). Customer detail sheet shows profile info + full order history with clickable orders. Dual-sheet interaction: customer detail on right, order detail on left. New customer creation via sheet form.
- **Overview/Stats** ‚Äî Order counts, production status breakdown, revenue (optional)

### 8.2 Printshop Manager Dashboard
- **Production Queue** ‚Äî Items assigned to their shop(s), filterable by status
- **Suggested view:** Kanban board with columns: `assigned` ‚Üí `in_production` ‚Üí `on_hold` ‚Üí `ready`
- **Item Detail** ‚Äî Product info, specs, files, notes. NO payment info
- **Mark `picked_up`** ‚Äî For customer pickup items

### 8.3 Driver Dashboard (Mobile-First)
- **Delivery Queue** ‚Äî Shows ALL deliverable items (status `ready` or `out_for_delivery`, `delivery_method = 'delivery'`) grouped by priority:
  - üî¥ Overdue
  - üü† Due Today
  - üü° Due Tomorrow
  - ‚ö™ Upcoming & Unscheduled
- **AI-Generated Route** ‚Äî Driver inputs shift end time (e.g., 17:00), AI generates optimized route with pickups and dropoffs
- **Live Route Map** ‚Äî Mapbox GL map showing completed/current/upcoming stops with color-coded markers and road-following route lines
- **Real-Time New Item Detection** ‚Äî Watcher detects new ready items during active route, prompts driver to recalculate with new stops added
- **Item Transfer Between Active Drivers** ‚Äî Transfer items/stops to other active drivers when needed (e.g., route overflow, shift end)
- **Route View** ‚Äî Ordered stop list with status indicators (pending, current, completed). Shows estimated arrival times, stop durations, and AI notes
- **Stop Completion** ‚Äî Tap to mark each stop as completed. Pickup stops auto-lock items (prevents unassignment)
- **Mark `picked_up`** ‚Äî For customer pickup items (if driver is at a shop)
- **Driver Tasks** ‚Äî Ad-hoc tasks with notes and photos
- **Delivery History** ‚Äî Table view of completed deliveries (delivered, picked_up, canceled). Search by product, order, customer. Read-only archive.

---

## 9. AI-Powered Route Optimization (OpenAI)

### 9.1 Overview

Kroma uses **OpenAI (gpt-4o)** to generate optimized delivery routes with shift time awareness. The AI system replaces manual order selection with intelligent route planning that considers time constraints, distances, stop priorities, and operational rules.

**Home Base (Montr√©al):** 4641 Av. Papineau, Montr√©al, QC H2H 1V3

### 9.2 Route Generation Flow

1. **Driver starts route:**
   - Clicks "Start Route" button in DriverDeliveries view
   - System detects all deliverable items (status `ready` or `out_for_delivery`, `delivery_method = 'delivery'`)
   - StartRouteDialog prompts for shift end time (presets: 15:00, 16:00, 17:00, 18:00, or custom)
   - System builds stops: pickups at printshops + dropoffs at customer addresses
   - System calls `generateRoute()` in `src/lib/route-service.ts` with stop inputs and shift end time

2. **OpenAI generates route:**
   - Builds structured prompt with Montr√©al-specific context (home base, stop details, constraints, shift duration)
   - Calls `gpt-4o` with temperature 0.2 for consistent, deterministic routing
   - AI returns optimized stop sequence with estimated times, durations, distances, notes, and warnings
   - Response includes `stopsOverCapacity` count for stops that may not fit in shift

3. **Route activation:**
   - Driver store creates `DriverRoute` object with enriched stops
   - All relevant items marked as `out_for_delivery`
   - Items assigned to current driver (prevents other drivers from seeing them)
   - Route UI shows optimized stop sequence with status indicators

### 9.3 Key Routing Rules

**Enforced by AI:**
- Home base (4641 Av. Papineau) must be first stop
- All pickups before their related dropoffs
- Time-aware prioritization (overdue items get priority)
- Realistic stop durations (5-10 min pickup, 10-15 min dropoff)
- Distance and drive time optimization for Montr√©al geography
- Stops beyond shift capacity flagged with warnings

**Stop Structure:**
- **Type:** `pickup` (at printshop) or `dropoff` (at customer) or `task` (ad-hoc driver task)
- **Status:** `pending` ‚Üí `current` ‚Üí `completed`
- **Locked items:** Items physically picked up cannot be unassigned (prevents inventory loss)
- **Metadata:** Estimated arrival time, duration, notes, photos, issue flags, cancellation

### 9.4 Mid-Route Updates

When new items become `ready` during an active route:
- System detects new deliverable items via watcher (realtime subscription on `order_items`)
- Shows notification: "New deliveries available. Recalculate route to add them?"
- Driver confirms recalculation
- System calls `recalculateRoute()` (NOT `generateRoute()`)
- **Preserves completed stops** ‚Äî only re-optimizes pending stops + new items
- Driver route updates seamlessly with new stops inserted

### 9.5 Multi-Driver Coordination

Multiple drivers can be active simultaneously with item assignment isolation:

**Active Driver Sessions:**
- Login auto-registers driver session (via `driverStore.registerDriverSession()`)
- Logout auto-unregisters session
- Active drivers tracked in `driverStore.activeSessions`

**Item Assignment Rules:**
- Items assigned to driver when route starts (on `out_for_delivery` transition)
- Other drivers cannot see assigned items in their deliverable queue
- Filter logic: `!driverStore.isItemAssignedToOtherDriver(item.id)`

**Transfer Between Drivers:**
- TransferDialog shows other active drivers with status (On Route / Available)
- Driver can transfer items to another active driver
- Locked (picked-up) items can only be transferred (cannot be unassigned)
- Transfer updates item assignment and removes stops from source driver's route

---

## 10. Mapbox Route Visualization

The driver route view includes a live Mapbox GL map showing the full route with color-coded stops and road-following lines.

**Component:** `RouteMap.vue` ‚Äî self-contained map

**Map elements:**
- üè† Home base marker (dark circle with house icon) at 4641 Av. Papineau
- ‚úÖ Completed stops ‚Äî green pins with checkmark
- üìç Current stop ‚Äî large blue pulsing pin with sequence number
- ‚ö™ Upcoming stops ‚Äî gray pins with sequence numbers
- üö´ Cancelled stops ‚Äî red pins with X

**Route lines:**
- Solid green line ‚Äî completed segments (thicker, 5px)
- Solid blue line ‚Äî current segment (to active stop, 6px)
- Dashed gray line ‚Äî upcoming segments (4px, dashed)

**Line rendering:**
- Lines follow actual roads via Mapbox Directions API (`/directions/v5/mapbox/driving/`)
- Supports up to 25 waypoints per request (chunks larger routes)
- Graceful fallback to straight lines if API blocked

**Token:** `VITE_MAPBOX_TOKEN` in `.env`

**Interaction:**
- Click marker ‚Üí popup with stop info (name, address, ETA, status)
- Click stop in sidebar ‚Üí map flies to that stop
- Auto-fits bounds to show all markers on initial render

---

## 11. File Handling

- All files are stored in **Supabase Storage** in a single private bucket (`files`)
- Storage path convention: `{entity_type}/{entity_id}/{filename}`
- Shopify files are downloaded during ingestion and stored in Supabase
- Manual orders: Manager uploads files directly
- Web form orders: Files are received and stored during ingestion
- Files are linked to entities via the `order_files` table with polymorphic `entity_type` + `entity_id`
- **Production files** (artwork, proof, reference) ‚Üí linked to `order_item`
- **Driver photos** (delivery_photo, issue_photo) ‚Üí linked to `order_item` or `driver_task`
- File count displayed in orders table = production files only (not delivery photos)

---

## 12. Realtime Updates

Uses **Supabase Realtime** subscriptions. With ~6-7 concurrent users, all clients subscribe to all changes and filter by role in the frontend. No per-shop or per-driver channel sharding needed.

**Tables with Realtime enabled:**

| Table         | Events              | Purpose                                    |
|---------------|---------------------|--------------------------------------------|
| orders        | INSERT, UPDATE      | New orders, payment updates                |
| order_items   | INSERT, UPDATE      | Status changes, assignments, new items     |
| notes         | INSERT, UPDATE, DELETE | Collaborative notes                     |
| activities    | INSERT              | Activity feed                              |
| driver_tasks  | INSERT, UPDATE      | Task assignments, status changes           |
| order_files   | INSERT, DELETE      | File uploads, deletions                    |

**How it works:**
- Manager dashboard updates live when new orders arrive
- Printshop Manager queue updates when items are assigned to their shop
- Driver queue updates when items become `ready`
- Status changes are reflected in real-time across all connected clients
- Notes appear instantly for all users viewing the same order/item
- New driver tasks appear in the assigned driver's queue immediately

**Frontend pattern:** Supabase Realtime pushes changes ‚Üí Pinia store updates reactive state ‚Üí Vue computed properties recompute ‚Üí UI updates automatically. The `computeOrderStatus()` rollup recomputes client-side when item statuses change.

---

## 13. Build Phases

### Phase 1 ‚Äî UI Foundation (Mock Data) ‚úÖ COMPLETE
- Vue 3 + Shadcn-vue + Pinia project scaffolding
- Mock data layer (`/data/mock`) with JSON/JS objects for all entities
- Data service layer (Pinia stores + composables) abstracting data access
- Mock auth with login screen (test accounts, no Supabase)
- Manager views: Order list (table + kanban), order detail, manual order entry, printshop assignment, customer management
- Printshop Manager views: Production queue (kanban), item detail with status controls
- Driver views: Delivery queue, AI route generation, live route map, stop completion, delivery history

### Phase 2 ‚Äî Supabase Integration ‚Üê NEXT
- Supabase project setup (database, auth, storage)
- Run `supabase-schema.sql` to create all tables, enums, indexes, triggers
- Replace Pinia store internals to use Supabase client (composable/component APIs unchanged)
- Real auth flow (email/password login via Supabase Auth)
- Minimal RLS: `auth.uid() IS NOT NULL` on all tables (role enforcement is frontend-only)
- File upload to Supabase Storage (single private `files` bucket)
- Supabase Realtime subscriptions for live updates on all key tables
- Migrate notes system to polymorphic `notes` table
- Implement `driver_tasks` persistence
- Implement `activities` as write-once event log
- Switch `status_history` from embedded arrays to lazy-loaded separate table

### Phase 3 ‚Äî Ingestion
- Shopify webhook receiver (all stores)
- Shopify payload normalization
- Shopify file download + storage
- Web form API endpoint
- Customer matching/dedup on ingestion

### Phase 4 ‚Äî Delivery & Route Optimization
- Google Maps API integration
- Route optimization (Directions API with waypoint optimization)
- Pickup/dropoff sequencing with constraints
- Live route view for driver
- Stop completion tracking

### Phase 5 ‚Äî Billing & Polish
- Outbound billing webhook at `ready` status
- Dashboard analytics / overview stats
- Customer management (merge, search, history)
- Notifications (optional)
- Shopify status sync-back (optional)

---

## 14. Technical Notes

### Supabase Auth
- Users authenticate via Supabase Auth (email/password)
- Role and shop scoping stored in `users` table
- No complex RLS ‚Äî single policy per table: `auth.uid() IS NOT NULL`
- Role enforcement handled entirely in the frontend (trusted internal users)

### Supabase RLS Approach
This is an internal app with ~6-7 trusted users. RLS is minimal ‚Äî just prevents unauthenticated access. The frontend hides options based on role (e.g., drivers can't see payment fields, printshop managers only see their items). This is "dumb-proof" protection, not security.

### Vercel Deployment
- Vue 3 SPA deployed on Vercel
- Serverless functions for webhook endpoints (`/api/ingest/shopify`, `/api/ingest/webform`)
- Google Maps API key stored server-side in Vercel environment variables
- Billing webhook outbound calls made from serverless functions
- OpenAI API key moves from client-side `.env` to serverless function in Phase 2+

### Order-Level Status Rollup
Since tracking is at the item level, the order's "effective status" is derived:
- Order is `new` if any item is `new`
- Order is `in_production` if any item is `assigned` or `in_production`
- Order is `ready` if ALL non-canceled items are `ready`
- Order is `delivered` / `picked_up` if ALL non-canceled items are in a terminal state
- Order is `canceled` if ALL items are `canceled`

### Order-Level Delivery Method Rollup
Since delivery method is per-item, the order's display value is derived:
- All items `delivery` ‚Üí show `delivery`
- All items `customer_pickup` ‚Üí show `customer_pickup`
- Mixed ‚Üí show `mixed` (both icons)

### Storage
- Single private bucket: `files`
- Path convention: `{entity_type}/{entity_id}/{filename}`
- Authenticated users can upload, read, delete. No public access.

### Project Structure

```
src/
‚îú‚îÄ‚îÄ types/                      ‚Üê Standalone type definitions (survive Supabase migration)
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                   Barrel re-export
‚îÇ   ‚îú‚îÄ‚îÄ customer.ts
‚îÇ   ‚îú‚îÄ‚îÄ order.ts                   OrderSource, PaymentStatus, PaymentMethod, Order
‚îÇ   ‚îú‚îÄ‚îÄ order-item.ts              ItemStatus, DeliveryMethod, StatusHistoryEntry, OrderItem
‚îÇ   ‚îú‚îÄ‚îÄ order-file.ts              FileType, FileEntityType, OrderFile
‚îÇ   ‚îú‚îÄ‚îÄ printshop.ts               Printshop
‚îÇ   ‚îú‚îÄ‚îÄ user.ts                    UserRole, User
‚îÇ   ‚îú‚îÄ‚îÄ activity.ts                Activity types
‚îÇ   ‚îú‚îÄ‚îÄ note.ts                    NoteEntityType, NoteDepartment, Note
‚îÇ   ‚îî‚îÄ‚îÄ driver-task.ts             DriverTask types
‚îú‚îÄ‚îÄ lib/                        ‚Üê Shared utilities (no component dependencies)
‚îÇ   ‚îú‚îÄ‚îÄ formatters.ts              Domain formatters (dates, statuses, currency)
‚îÇ   ‚îú‚îÄ‚îÄ variants.ts                Badge/color variant mappings
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts               Filter options, kanban columns, domain enums
‚îÇ   ‚îú‚îÄ‚îÄ route-service.ts           OpenAI route generation & recalculation
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts                   General helpers (cn, etc.)
‚îú‚îÄ‚îÄ stores/                     ‚Üê Pinia stores (single source of truth)
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                    currentUser, login/logout, role getters
‚îÇ   ‚îú‚îÄ‚îÄ orders.ts                  orders + orderItems state, mutations, computed joins
‚îÇ   ‚îú‚îÄ‚îÄ customers.ts               customers state
‚îÇ   ‚îú‚îÄ‚îÄ printshops.ts              printshops state
‚îÇ   ‚îú‚îÄ‚îÄ drivers.ts                 Active drivers, routes, assignments, locked items
‚îÇ   ‚îî‚îÄ‚îÄ activities.ts              activity feed state
‚îú‚îÄ‚îÄ composables/                ‚Üê Thin wrappers around stores (stable API for components)
‚îÇ   ‚îú‚îÄ‚îÄ useOrders.ts
‚îÇ   ‚îú‚îÄ‚îÄ useOrderItems.ts
‚îÇ   ‚îú‚îÄ‚îÄ useCustomers.ts
‚îÇ   ‚îú‚îÄ‚îÄ usePrintshops.ts
‚îÇ   ‚îî‚îÄ‚îÄ useToast.ts
‚îú‚îÄ‚îÄ data/mock/                  ‚Üê Mock data arrays only (Phase 1, no type definitions)
‚îÇ   ‚îú‚îÄ‚îÄ orders.ts
‚îÇ   ‚îú‚îÄ‚îÄ order-items.ts
‚îÇ   ‚îú‚îÄ‚îÄ order-files.ts
‚îÇ   ‚îú‚îÄ‚îÄ customers.ts
‚îÇ   ‚îú‚îÄ‚îÄ printshops.ts
‚îÇ   ‚îú‚îÄ‚îÄ users.ts
‚îÇ   ‚îî‚îÄ‚îÄ activities.ts
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                        Primitives (Button, Badge, Card, Sheet, Dialog, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ AppLayout.vue              Top nav (role-aware)
‚îÇ   ‚îú‚îÄ‚îÄ DataTable.vue              Generic TanStack table
‚îÇ   ‚îú‚îÄ‚îÄ StatsCards.vue             Config-driven stat cards
‚îÇ   ‚îú‚îÄ‚îÄ OrderFilters.vue           Reusable filter bar
‚îÇ   ‚îú‚îÄ‚îÄ KanbanBoard.vue            Reusable kanban with drag/drop
‚îÇ   ‚îú‚îÄ‚îÄ KanbanCard.vue             Single kanban card
‚îÇ   ‚îú‚îÄ‚îÄ OrderExpandedRow.vue       Expanded row for table view
‚îÇ   ‚îú‚îÄ‚îÄ StatsSheet.vue             Drill-down sheet for stats
‚îÇ   ‚îú‚îÄ‚îÄ AssignmentDialog.vue       Confirmation dialog
‚îÇ   ‚îú‚îÄ‚îÄ StartRouteDialog.vue       Shift end time input for route generation
‚îÇ   ‚îú‚îÄ‚îÄ TransferDialog.vue         Transfer items between active drivers
‚îÇ   ‚îú‚îÄ‚îÄ ItemControls.vue           Reusable item editing (status, printshop, dates)
‚îÇ   ‚îú‚îÄ‚îÄ NotesSection.vue           Reusable notes CRUD
‚îÇ   ‚îú‚îÄ‚îÄ OrderDetailSheet.vue       Order detail slide-out
‚îÇ   ‚îú‚îÄ‚îÄ NewOrderSheet.vue          Manual order creation
‚îÇ   ‚îú‚îÄ‚îÄ DriverTaskSheet.vue        Ad-hoc driver tasks
‚îÇ   ‚îú‚îÄ‚îÄ ActivityFeed.vue           Right sidebar feed
‚îÇ   ‚îú‚îÄ‚îÄ ItemStatusCombobox.vue     Status dropdown
‚îÇ   ‚îî‚îÄ‚îÄ RouteMap.vue               Mapbox GL route visualization
‚îú‚îÄ‚îÄ views/
‚îÇ   ‚îú‚îÄ‚îÄ LoginView.vue              Login screen
‚îÇ   ‚îú‚îÄ‚îÄ manager/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ManagerOrders.vue      Orchestration only (~300 lines)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ManagerCustomers.vue
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ order-columns.ts       TanStack column defs (callback pattern)
‚îÇ   ‚îú‚îÄ‚îÄ printshop/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PrintshopQueue.vue     Kanban production queue
‚îÇ   ‚îî‚îÄ‚îÄ driver/
‚îÇ       ‚îú‚îÄ‚îÄ DriverDeliveries.vue   AI-powered delivery queue + route
‚îÇ       ‚îî‚îÄ‚îÄ DriverArchives.vue     Delivery history archives
‚îî‚îÄ‚îÄ router/index.ts                Role-aware routing with auth guards
```

### Data Service Layer Pattern
- **Pinia stores** are the single source of truth for all state
- **Composables** (`useOrders()`, `useCustomers()`, etc.) are thin wrappers providing a stable API
- Phase 1: Stores load from `/data/mock`
- Phase 2: Stores swap to Supabase client ‚Äî composable and component APIs unchanged
- Components never import from `/data/mock` directly

---

## 15. Open Items / TBD

- [ ] External billing app (webhook destination URL and payload format)
- [ ] Billing webhook retry logic and failure handling
- [ ] Shopify file attachment method (app, order notes, or separate upload)
- [ ] Notification system (email/SMS on status changes) ‚Äî future phase
- [ ] Customer-facing portal ‚Äî future phase
- [ ] Shopify status sync-back (update Shopify when Kroma status changes) ‚Äî future phase
- [ ] Proof approval workflow (customer approves proof before production) ‚Äî future phase
- [ ] Geocoding addresses to lat/lng for route optimization (Phase 4)